<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Worker Test - Gate33</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #0f172a; color: white; }
        .status { margin: 10px 0; padding: 15px; border-radius: 5px; }
        .success { background: #065f46; }
        .error { background: #7f1d1d; }
        .warning { background: #92400e; }
        .info { background: #1e3a8a; }
        pre { background: #1e293b; padding: 15px; border-radius: 5px; overflow-x: auto; }
        button { 
            background: #ff6b35; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #ff5722; }
    </style>
</head>
<body>
    <h1>🔧 Service Worker Test - Gate33</h1>
    <div id="results"></div>
    
    <div style="margin: 20px 0;">
        <button onclick="testServiceWorker()">🔄 Testar Service Worker</button>
        <button onclick="unregisterSW()">🗑️ Desregistrar SW</button>
        <button onclick="clearStorage()">🧹 Limpar Storage</button>
    </div>

    <script>
        let results = [];

        function addResult(test, status, message, details = null) {
            results.push({ test, status, message, details, timestamp: new Date().toISOString() });
            updateDisplay();
        }

        function updateDisplay() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = results.map(result => `
                <div class="status ${result.status}">
                    <strong>${result.test}:</strong> ${result.message}
                    ${result.details ? `<pre>${JSON.stringify(result.details, null, 2)}</pre>` : ''}
                </div>
            `).join('');
        }

        async function testServiceWorker() {
            results = []; // Clear previous results
            addResult("🚀 Iniciando", "info", "Testando Service Worker...");

            // Test 1: SW Support
            if ('serviceWorker' in navigator) {
                addResult("✅ Suporte", "success", "Service Worker é suportado pelo navegador");
            } else {
                addResult("❌ Suporte", "error", "Service Worker NÃO é suportado");
                return;
            }

            // Test 2: SW Registration
            try {
                addResult("🔄 Registrando", "info", "Tentando registrar /sw.js...");
                
                const registration = await navigator.serviceWorker.register('/sw.js', { 
                    scope: '/',
                    updateViaCache: 'none'
                });
                
                addResult("✅ Registro", "success", `Service Worker registrado com sucesso!`, {
                    scope: registration.scope,
                    updateViaCache: registration.updateViaCache,
                    active: !!registration.active,
                    installing: !!registration.installing,
                    waiting: !!registration.waiting
                });

                // Test 3: SW State
                if (registration.active) {
                    addResult("✅ Estado", "success", "Service Worker está ATIVO");
                } else if (registration.installing) {
                    addResult("⏳ Estado", "warning", "Service Worker está INSTALANDO...");
                    
                    registration.installing.addEventListener('statechange', () => {
                        addResult("🔄 Estado", "info", `SW State: ${registration.installing.state}`);
                        if (registration.installing.state === 'activated') {
                            addResult("✅ Ativado", "success", "Service Worker foi ativado!");
                        }
                    });
                } else if (registration.waiting) {
                    addResult("⏸️ Estado", "warning", "Service Worker está AGUARDANDO");
                } else {
                    addResult("❓ Estado", "warning", "Estado do Service Worker indefinido");
                }

                // Test 4: Check existing registrations
                const registrations = await navigator.serviceWorker.getRegistrations();
                addResult("📋 Registros", "info", `Total de SWs registrados: ${registrations.length}`, 
                    registrations.map(reg => ({
                        scope: reg.scope,
                        active: !!reg.active,
                        installing: !!reg.installing,
                        waiting: !!reg.waiting
                    }))
                );

            } catch (error) {
                addResult("❌ Erro", "error", `Falha ao registrar: ${error.message}`, {
                    error: error.name,
                    message: error.message,
                    stack: error.stack
                });
            }

            // Test 5: Check if SW file is accessible
            try {
                const response = await fetch('/sw.js');
                if (response.ok) {
                    const content = await response.text();
                    addResult("✅ Arquivo", "success", `sw.js acessível (${content.length} caracteres)`);
                } else {
                    addResult("❌ Arquivo", "error", `sw.js não acessível: HTTP ${response.status}`);
                }
            } catch (error) {
                addResult("❌ Arquivo", "error", `Erro ao acessar sw.js: ${error.message}`);
            }
        }

        async function unregisterSW() {
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (let registration of registrations) {
                    await registration.unregister();
                }
                addResult("🗑️ Limpeza", "success", "Todos os Service Workers foram desregistrados");
            } catch (error) {
                addResult("❌ Limpeza", "error", `Erro ao desregistrar: ${error.message}`);
            }
        }

        function clearStorage() {
            // Clear various storage types
            localStorage.clear();
            sessionStorage.clear();
            
            // Clear IndexedDB
            if ('indexedDB' in window) {
                indexedDB.databases().then(databases => {
                    databases.forEach(db => {
                        indexedDB.deleteDatabase(db.name);
                    });
                });
            }
            
            addResult("🧹 Storage", "success", "Storage limpo (localStorage, sessionStorage, IndexedDB)");
        }

        // Auto-run test on load
        window.addEventListener('load', () => {
            setTimeout(testServiceWorker, 1000);
        });
    </script>
</body>
</html>
