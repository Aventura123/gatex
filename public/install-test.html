<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Install Test - Gate33</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        body { font-family: monospace; padding: 20px; background: #0f172a; color: white; }
        .status { margin: 10px 0; padding: 15px; border-radius: 5px; }
        .success { background: #065f46; }
        .error { background: #7f1d1d; }
        .warning { background: #92400e; }
        .info { background: #1e3a8a; }
        button { 
            background: #ff6b35; 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 10px;
            font-size: 16px;
        }
        button:hover { background: #ff5722; }
        button:disabled { background: #666; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>üöÄ Install Test - Gate33 PWA</h1>
    
    <div id="status"></div>
    
    <div>
        <button id="installBtn" onclick="installPWA()" disabled>üì± Instalar PWA</button>
        <button onclick="checkCriteria()">üîç Verificar Crit√©rios</button>
        <button onclick="simulateInstall()">‚ö° Simular Install</button>
        <button onclick="clearData()">üßπ Limpar Dados</button>
    </div>

    <div id="logs" style="margin-top: 20px;"></div>

    <script>
        let deferredPrompt;
        let installButton = document.getElementById('installBtn');
        let statusDiv = document.getElementById('status');
        let logsDiv = document.getElementById('logs');

        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logsDiv.appendChild(div);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(`[PWA Install Test] ${message}`);
        }

        // Escutar beforeinstallprompt
        window.addEventListener('beforeinstallprompt', (e) => {
            log('üéâ beforeinstallprompt disparado! PWA √© instal√°vel', 'success');
            
            // Prevenir o prompt autom√°tico
            e.preventDefault();
            
            // Salvar o evento
            deferredPrompt = e;
            
            // Habilitar bot√£o de instala√ß√£o
            installButton.disabled = false;
            installButton.textContent = 'üì± Instalar PWA (Dispon√≠vel!)';
            
            statusDiv.innerHTML = '<div class="status success">‚úÖ PWA est√° pronto para instala√ß√£o!</div>';
        });

        // Escutar instala√ß√£o
        window.addEventListener('appinstalled', () => {
            log('üéä PWA foi instalado com sucesso!', 'success');
            deferredPrompt = null;
            installButton.disabled = true;
            installButton.textContent = '‚úÖ PWA Instalado';
            statusDiv.innerHTML = '<div class="status success">‚úÖ PWA instalado com sucesso!</div>';
        });

        async function installPWA() {
            if (!deferredPrompt) {
                log('‚ùå Nenhum prompt de instala√ß√£o dispon√≠vel', 'error');
                return;
            }

            log('üì± Mostrando prompt de instala√ß√£o...', 'info');
            
            // Mostrar o prompt
            deferredPrompt.prompt();
            
            // Aguardar a escolha do usu√°rio
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                log('‚úÖ Usu√°rio aceitou a instala√ß√£o', 'success');
            } else {
                log('‚ùå Usu√°rio cancelou a instala√ß√£o', 'warning');
            }
            
            deferredPrompt = null;
        }

        async function checkCriteria() {
            log('üîç Verificando crit√©rios PWA...', 'info');
            
            const criteria = [];
            
            // 1. HTTPS
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
            criteria.push(`HTTPS: ${isSecure ? '‚úÖ' : '‚ùå'} (${location.protocol})`);
            
            // 2. Manifest
            try {
                const manifestResponse = await fetch('/manifest.json');
                const manifest = await manifestResponse.json();
                criteria.push(`Manifest: ‚úÖ V√°lido`);
                criteria.push(`- Name: ${manifest.name}`);
                criteria.push(`- Display: ${manifest.display}`);
                criteria.push(`- Start URL: ${manifest.start_url}`);
                criteria.push(`- Icons: ${manifest.icons.length} encontrados`);
            } catch (error) {
                criteria.push(`Manifest: ‚ùå Erro - ${error.message}`);
            }
            
            // 3. Service Worker
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        criteria.push(`Service Worker: ‚úÖ Registrado (${registration.scope})`);
                        criteria.push(`- Estado: ${registration.active ? 'Ativo' : 'Inativo'}`);
                    } else {
                        criteria.push(`Service Worker: ‚ùå N√£o registrado`);
                    }
                } catch (error) {
                    criteria.push(`Service Worker: ‚ùå Erro - ${error.message}`);
                }
            } else {
                criteria.push(`Service Worker: ‚ùå N√£o suportado`);
            }
            
            // 4. Display Mode
            const displayMode = window.matchMedia('(display-mode: standalone)').matches ? 'standalone' :
                               window.matchMedia('(display-mode: minimal-ui)').matches ? 'minimal-ui' :
                               window.matchMedia('(display-mode: fullscreen)').matches ? 'fullscreen' : 'browser';
            criteria.push(`Display Mode: ${displayMode}`);
            
            // 5. User Engagement (heur√≠stica do Chrome)
            criteria.push(`User Agent: ${navigator.userAgent.includes('Chrome') ? 'Chrome ‚úÖ' : 'Outro navegador'}`);
            
            log(`Crit√©rios PWA:\n${criteria.join('\n')}`, 'info');
        }

        function simulateInstall() {
            log('‚ö° Tentando simular condi√ß√µes de instala√ß√£o...', 'info');
            
            // Verificar se j√° foi dismissado
            const dismissed = localStorage.getItem('pwa-install-dismissed');
            if (dismissed) {
                log(`‚ö†Ô∏è PWA foi dismissado em: ${new Date(parseInt(dismissed)).toLocaleString()}`, 'warning');
                log('üßπ Limpando flag de dismissal...', 'info');
                localStorage.removeItem('pwa-install-dismissed');
            }
            
            // Limpar flag de instalado
            const installed = localStorage.getItem('pwa-installed');
            if (installed) {
                log('üßπ Limpando flag de instala√ß√£o...', 'info');
                localStorage.removeItem('pwa-installed');
            }
            
            log('üîÑ Recarregue a p√°gina para tentar novamente', 'info');
        }

        function clearData() {
            localStorage.clear();
            sessionStorage.clear();
            log('üßπ Todos os dados locais foram limpos', 'success');
            log('üîÑ Recarregue a p√°gina para come√ßar do zero', 'info');
        }

        // Auto-check ao carregar
        window.addEventListener('load', () => {
            log('üöÄ P√°gina carregada, verificando PWA...', 'info');
            
            setTimeout(() => {
                if (!deferredPrompt) {
                    log('‚è≥ beforeinstallprompt ainda n√£o disparou...', 'warning');
                    statusDiv.innerHTML = '<div class="status warning">‚è≥ Aguardando crit√©rios de instala√ß√£o...</div>';
                }
            }, 3000);
            
            // Auto-check crit√©rios
            setTimeout(checkCriteria, 1000);
        });
    </script>
</body>
</html>
