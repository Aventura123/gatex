<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Debug - Gate33</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        body { font-family: monospace; padding: 20px; background: #0f172a; color: white; }
        .test { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .pass { background: #065f46; }
        .fail { background: #7f1d1d; }
        .warn { background: #92400e; }
        pre { background: #1e293b; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .status { display: inline-block; width: 20px; text-align: center; margin-right: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç PWA Debug Tool - Gate33</h1>
        <p>Verificando configura√ß√£o do Progressive Web App...</p>
    </div>
    <div id="results">
        <div class="test warn">
            <strong>‚è≥ Executando testes...</strong> Aguarde alguns segundos.
        </div>
    </div>    
    <script>
        let results = [];
        
        async function debugPWA() {
            results = []; // Limpar resultados
            updateResults('Iniciando diagn√≥stico PWA...');
            
            // Test 1: Service Worker
            try {
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        results.push({
                            test: "Service Worker",
                            status: "pass",
                            message: `‚úÖ Registrado: ${registration.scope}`,
                            details: `Estado: ${registration.active ? 'Ativo' : 'Inativo'}`
                        });
                    } else {
                        results.push({
                            test: "Service Worker",
                            status: "fail",
                            message: "‚ùå N√£o encontrado - tentando registrar...",
                            details: "PWA precisa de Service Worker para funcionar"
                        });
                        
                        // Tentar registrar
                        try {
                            const newReg = await navigator.serviceWorker.register('/sw.js');
                            results.push({
                                test: "Service Worker (Registro)",
                                status: "pass",
                                message: `‚úÖ Registrado com sucesso: ${newReg.scope}`
                            });
                        } catch (regError) {
                            results.push({
                                test: "Service Worker (Registro)",
                                status: "fail",
                                message: `‚ùå Erro no registro: ${regError.message}`
                            });
                        }
                    }
                } else {
                    results.push({
                        test: "Service Worker",
                        status: "fail",
                        message: "‚ùå N√£o suportado pelo navegador",
                        details: "Navegador n√£o suporta Service Workers"
                    });
                }
            } catch (error) {
                results.push({
                    test: "Service Worker",
                    status: "fail",
                    message: `‚ùå Erro: ${error.message}`
                });
            }
            
            // Test 2: Manifest
            try {
                const response = await fetch('/manifest.json');
                if (response.ok) {
                    const manifest = await response.json();
                    
                    // Check required fields
                    const requiredFields = ['name', 'short_name', 'start_url', 'display', 'icons'];
                    const missingFields = requiredFields.filter(field => !manifest[field]);
                    
                    if (missingFields.length === 0) {
                        results.push({
                            test: "Manifest",
                            status: "pass",
                            message: `‚úÖ V√°lido - Display: ${manifest.display}`,
                            details: `Nome: ${manifest.name}, Start URL: ${manifest.start_url}`
                        });
                    } else {
                        results.push({
                            test: "Manifest",
                            status: "fail",
                            message: `‚ùå Campos faltando: ${missingFields.join(', ')}`,
                            details: "Campos obrigat√≥rios ausentes"
                        });
                    }
                    
                    // Check icons
                    const icons192 = manifest.icons.filter(icon => 
                        icon.sizes.includes('192') && (icon.purpose === 'any' || !icon.purpose)
                    );
                    const icons512 = manifest.icons.filter(icon => 
                        icon.sizes.includes('512') && (icon.purpose === 'any' || !icon.purpose)
                    );
                    
                    if (icons192.length > 0 && icons512.length > 0) {
                        results.push({
                            test: "√çcones PWA",
                            status: "pass",
                            message: "‚úÖ √çcones 192x192 e 512x512 encontrados",
                            details: `192x192: ${icons192.length}, 512x512: ${icons512.length}`
                        });
                    } else {
                        results.push({
                            test: "√çcones PWA",
                            status: "fail",
                            message: `‚ùå √çcones insuficientes`,
                            details: `192x192: ${icons192.length}, 512x512: ${icons512.length} (ambos necess√°rios)`
                        });
                    }
                    
                } else {
                    results.push({
                        test: "Manifest",
                        status: "fail",
                        message: `‚ùå HTTP ${response.status}`,
                        details: "Arquivo manifest.json n√£o acess√≠vel"
                    });
                }
            } catch (error) {
                results.push({
                    test: "Manifest",
                    status: "fail",
                    message: `‚ùå Erro: ${error.message}`
                });
            }
            
            // Test 3: HTTPS
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            results.push({
                test: "HTTPS",
                status: isSecure ? "pass" : "fail",
                message: isSecure ? `‚úÖ Protocolo seguro: ${location.protocol}` : `‚ùå HTTPS necess√°rio: ${location.protocol}`,
                details: `Host: ${location.hostname}`
            });
            
            // Test 4: Install Prompt
            let installPromptAvailable = false;
            const checkInstallPrompt = () => {
                window.addEventListener('beforeinstallprompt', (e) => {
                    installPromptAvailable = true;
                    e.preventDefault();
                    
                    results.push({
                        test: "Install Prompt",
                        status: "pass",
                        message: "‚úÖ beforeinstallprompt disparado",
                        details: "PWA √© considerado instal√°vel pelo navegador"
                    });
                    updateResults();
                });
                
                // Wait 5 seconds to see if prompt fires
                setTimeout(() => {
                    if (!installPromptAvailable) {
                        const isAlreadyInstalled = window.matchMedia('(display-mode: standalone)').matches || 
                                                 window.navigator.standalone === true;
                        
                        results.push({
                            test: "Install Prompt",
                            status: isAlreadyInstalled ? "warn" : "fail",
                            message: isAlreadyInstalled ? 
                                    "‚ö†Ô∏è N√£o disparou (j√° instalado)" : 
                                    "‚ùå beforeinstallprompt n√£o disparou",
                            details: isAlreadyInstalled ? 
                                    "App j√° est√° instalado" : 
                                    "PWA pode n√£o atender crit√©rios de instala√ß√£o"
                        });
                        updateResults();
                    }
                }, 5000);
            };
            
            // Test 5: Current PWA Status
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            const isInWebAppiOS = window.navigator.standalone === true;
            const isPWAInstalled = isStandalone || isInWebAppiOS;
            
            results.push({
                test: "Status PWA",
                status: isPWAInstalled ? "pass" : "warn",
                message: isPWAInstalled ? "‚úÖ Rodando como PWA" : "‚ö†Ô∏è Rodando no navegador",
                details: isPWAInstalled ? "App est√° em modo standalone" : "App pode ser instalado"
            });
            
            // Test 6: Display Mode
            const displayMode = window.matchMedia('(display-mode: standalone)').matches ? 'standalone' :
                               window.matchMedia('(display-mode: minimal-ui)').matches ? 'minimal-ui' :
                               window.matchMedia('(display-mode: fullscreen)').matches ? 'fullscreen' :
                               'browser';
            
            results.push({
                test: "Display Mode",
                status: displayMode === 'standalone' ? "pass" : "warn",
                message: `${displayMode === 'standalone' ? '‚úÖ' : '‚ö†Ô∏è'} Modo: ${displayMode}`,
                details: "standalone = PWA instalado, browser = navegador normal"
            });
            
            // Test 7: Browser Info
            const isChrome = navigator.userAgent.includes('Chrome');
            const isEdge = navigator.userAgent.includes('Edg');
            const isSafari = navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome');
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            results.push({
                test: "Navegador",
                status: "pass",
                message: `‚ÑπÔ∏è ${isChrome ? 'Chrome' : isEdge ? 'Edge' : isSafari ? 'Safari' : 'Outro'} ${isMobile ? '(Mobile)' : '(Desktop)'}`,
                details: navigator.userAgent
            });
            
            updateResults();
            checkInstallPrompt();
        }
        
        function updateResults(loadingMessage = null) {
            const resultsDiv = document.getElementById('results');
            
            if (loadingMessage) {
                resultsDiv.innerHTML = `
                    <div class="test warn">
                        <strong>‚è≥ ${loadingMessage}</strong>
                    </div>
                `;
                return;
            }
            
            const html = results.map(result => `
                <div class="test ${result.status}">
                    <strong>${result.test}:</strong> ${result.message}
                    ${result.details ? `<br><small style="opacity: 0.8;">${result.details}</small>` : ''}
                </div>
            `).join('');
            
            // Add summary
            const passCount = results.filter(r => r.status === 'pass').length;
            const failCount = results.filter(r => r.status === 'fail').length;
            const warnCount = results.filter(r => r.status === 'warn').length;
            
            const summary = `
                <div style="margin-top: 30px; padding: 20px; background: #1e293b; border-radius: 10px;">
                    <h2>üìä Resumo dos Testes</h2>
                    <p>‚úÖ Passou: ${passCount} | ‚ùå Falhou: ${failCount} | ‚ö†Ô∏è Aten√ß√£o: ${warnCount}</p>
                    <hr style="border-color: #374151; margin: 15px 0;">
                    <h3>üí° Diagn√≥stico:</h3>
                    ${failCount === 0 && passCount > 0 ? 
                        '<p style="color: #10b981;">üéâ PWA configurado corretamente! Navegador deve reconhec√™-lo como instal√°vel.</p>' :
                        failCount > 0 ? 
                        '<p style="color: #ef4444;">‚ö†Ô∏è Existem problemas que impedem o PWA de funcionar corretamente.</p>' :
                        '<p style="color: #f59e0b;">üîÑ Testes ainda em execu√ß√£o...</p>'
                    }
                    <details style="margin-top: 15px;">
                        <summary style="cursor: pointer; font-weight: bold;">ÔøΩ Informa√ß√µes T√©cnicas</summary>
                        <pre style="margin-top: 10px; font-size: 12px;">${JSON.stringify({
                            timestamp: new Date().toISOString(),
                            url: location.href,
                            userAgent: navigator.userAgent,
                            displayMode: window.matchMedia('(display-mode: standalone)').matches ? 'standalone' : 'browser',
                            serviceWorkerSupport: 'serviceWorker' in navigator,
                            manifestUrl: '/manifest.json',
                            localStorage: !!window.localStorage,
                            https: location.protocol === 'https:' || location.hostname === 'localhost'
                        }, null, 2)}</pre>
                    </details>
                </div>
            `;
            
            resultsDiv.innerHTML = html + summary;
        }
        
        // Iniciar diagn√≥stico quando a p√°gina carregar
        window.addEventListener('load', () => {
            setTimeout(() => {
                debugPWA();
            }, 1000);
        });
    </script>
</body>
</html>
